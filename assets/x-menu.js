export default class XMenu extends HTMLElement{constructor(){super()}connectedCallback(){this.current_width=window.innerWidth,this.state="closed",this.parent_links=this.querySelectorAll(".x-menu--level-1--link > a"),this.sub_menu_links=this.querySelectorAll('.x-menu--level-1--link:not([data-x-menu--depth="1"]) > a'),this.overlap_parent=parseInt(this.getAttribute("data-x-menu--overlap-parent")),this.header_root=document.querySelector(".header--root"),this.sub_menu_items=[],this.parents_with_sub_menu=[],this.sub_menu_links.forEach(e=>{var t=e.parentNode;this.parents_with_sub_menu.push(t);const s=e.parentNode.querySelectorAll("ul a");s.forEach(e=>this.sub_menu_items.push(e))}),this.load()}disconnectedCallback(){window.off("resize.XMenu"),this.parent_links.off("focus.XMenu"),this.sub_menu_links.off("touchstart.XMenu focus.XMenu"),this.parents_with_sub_menu.off("mouseleave.XMenu"),this.parents_with_sub_menu.forEach(e=>{e.querySelectorAll(":scope > a").off("mouseenter.XMenu")})}load(){this.arrangeMegaNav(),this.listeners(),this.checkOverlap(),this.resizeListeners(),this.transitionListeners()}listeners(){this.parents_with_sub_menu.forEach(e=>{e.querySelectorAll(":scope > a").on("mouseenter.XMenu",e=>this.slideDown(e.target))}),this.parents_with_sub_menu.on("mouseleave.XMenu",()=>this.slideUp()),this.parent_links.on("focus.XMenu",()=>this.slideUp),this.sub_menu_links.on("focus.XMenu",e=>this.slideDown(e.target)),this.sub_menu_links.on("touchstart.XMenu",e=>{e.preventDefault(),"true"===e.target.parentNode.getAttribute("data-x-menu--open")?this.slideUp(!1):this.slideDown(e.target)})}checkOverlap(){if(theme.utils.isTouchDevice()&&"large"!==theme.mqs.current_window)return this.setAttribute("data-x-menu--overlap",!0),this.header_root.setAttribute("data-x-menu--overlap",!0),window.trigger("theme:XMenu:loaded"),!1;this.setAttribute("data-x-menu--overlap",!1),this.header_root.setAttribute("data-x-menu--overlap",!1);let e=this;1===this.overlap_parent?e=e.parentNode:2===this.overlap_parent&&(e=e.parentNode.parentNode);var t=e.parentNode,s=e.index();let n=!1,i=(1<s&&(n=t.children[s-1]),!1);if(s+1<t.children.length&&(i=t.children[s+1]),n){const r=n.querySelector(":scope > :last-child");t=r.offset().left+r.offsetWidth;e.offset().left-1<=t&&(this.setAttribute("data-x-menu--overlap",!0),this.header_root.setAttribute("data-x-menu--overlap",!0))}if(i){const o=e.querySelector(":scope > :last-child");s=o.offset().left+o.offsetWidth;i.offset().left-1<=s&&(this.setAttribute("data-x-menu--overlap",!0),this.header_root.setAttribute("data-x-menu--overlap",!0))}window.trigger("theme:XMenu:loaded")}resizeListeners(){window.on("resize.XMenu",theme.utils.debounce(100,()=>{this.current_width!==window.innerWidth&&(this.checkOverlap(),this.current_width=window.innerWidth)}))}arrangeMegaNav(){if(0===this.parents_with_sub_menu.length)return!1;const e=this.querySelectorAll('[data-x-menu--depth="3"] .x-menu--level-2--container');e.length&&e.forEach(e=>{const t=e.querySelectorAll('[data-x-menu--single-parent="true"]');if(t.length){const s=theme.utils.parseHtml('<div class="x-menu--single-parents"></div>');e.prepend(s);e=document.createElement("ul");s.appendChild(e),t.forEach(e=>{s.querySelector("ul").appendChild(e)})}})}slideDown(e,t=!1){clearTimeout(this.timer);const s=e.parentNode;if("true"===s.getAttribute("data-x-menu--open")||"closing"===this.state)return!1;if(this.slideUp(!1),t&&"complete"!==t)this.timer=setTimeout(()=>this.slideDown(e,"complete"),t);else{s.querySelector(".icon--chevron-up").style.display="inline",s.querySelector(".icon--chevron-down").style.display="none",s.setAttribute("data-x-menu--open",!0);const n=s.querySelector(".x-menu--level-2--container");n&&(n.setState("forwards"),n.style.height="auto"),e.setAttribute("aria-expanded",!0),this.state="open"}}slideUp(e=300){let t=!1,s=!1,n;for(let e=0;e<this.parents_with_sub_menu.length;e++)if("true"===(n=this.parents_with_sub_menu[e]).getAttribute("data-x-menu--open")){s=n,t=s.querySelector(":scope > a");break}if(s)if(e)this.timer=setTimeout(()=>this.slideUp(!1),e);else{s.querySelector(".icon--chevron-up").style.display="none",s.querySelector(".icon--chevron-down").style.display="inline",s.setAttribute("data-x-menu--open",!1);const i=s.querySelector(".x-menu--level-2--container");i&&i.setState("backwards"),t&&t.setAttribute("aria-expanded",!1),this.state="closing"}}transitionListeners(){this.sub_menu_links.forEach(e=>{const t=e.parentNode;if(t){const s=t.querySelectorAll(".x-menu--level-2--container");s.on("transition:at_start",e=>{e.target.style.height="0",this.state="closed"})}})}}